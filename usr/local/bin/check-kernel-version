#!/usr/bin/env python3

import subprocess
import requests
import sys

from pynotifier import NotificationClient, Notification
from pynotifier.backends import platform

if __name__ == "__main__":
    installed = subprocess.run(["pacman", "-Q", "--color", "never", "linux"],
                               capture_output=True,
                               text=True,
                               check=True)
    installed = installed.stdout.strip().split(' ')[1]

    request = requests.get("https://archlinux.org/packages/core/x86_64/linux/json/")

    remote = request.json()["pkgver"] + '-' + request.json()["pkgrel"]

    if installed != remote:
        if len(sys.argv) > 1 and sys.argv[1] == "notify":
            notification_client = NotificationClient()
            notification_client.register_backend(platform.Backend())

            notification = Notification(title="Kernel is not up-to-date!",
                                        message=f"Current Version: {installed}\nNewest Version: {remote}")

            notification_client.notify_all(notification)
        else:
            print("Kernel is not up-to-date!")
            print(f"Current version: \x1b[1;31m{installed}\x1b[0m. Newest version: \x1b[1;32m{remote}\x1b[0m.")
